{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω—ã–π —á–∞—Ç - ChatTM{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar">
        <div class="sidebar-section">
            <h3> –ö–æ–º–Ω–∞—Ç—ã</h3>
            <div class="rooms-list">
                {% for room_name, room_data in rooms.items() %}
                <div class="room-item" onclick="joinRoom('{{ room_name }}')">
                    <div class="room-name"># {{ room_name }}</div>
                    <div class="room-info">
                        <span class="online-count">{{ room_data.users|length }}</span>
                        <span class="message-count">{{ room_data.messages|length }}</span>
                    </div>
                    <div class="room-desc">{{ room_data.description }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="sidebar-section">
            <h3> –û–Ω–ª–∞–π–Ω ({{ total_users }})</h3>
            <div id="users-list" class="users-list">
                {% for user in active_users.values() %}
                <div class="user-item"> {{ user }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-area">
        <div class="chat-header">
            <h2 id="current-room"># general</h2>
            <div id="room-users" class="room-users"></div>
            <div class="chat-actions">
                <button onclick="leaveCurrentRoom()" class="btn-secondary">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div id="messages" class="messages-container">
            <div class="welcome-message">
                <h3>üêç –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ChatTM!</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
        </div>

        <div id="typing-indicator" class="typing-indicator"></div>

        <div class="message-input-area">
            <input type="text" id="message-input" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                   onkeypress="handleKeyPress(event)"
                   disabled>
            <button onclick="sendMessage()" id="send-btn" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    let currentRoom = null;
    let typingTimer;

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
    function joinRoom(roomName) {
        if (currentRoom) {
            socket.emit('leave_room', {room: currentRoom});
        }
        
        currentRoom = roomName;
        document.getElementById('current-room').textContent = `# ${roomName}`;
        document.getElementById('messages').innerHTML = '';
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        
        socket.emit('join_room', {room: roomName});
    }

    // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
    function leaveCurrentRoom() {
        if (currentRoom) {
            socket.emit('leave_room', {room: currentRoom});
            currentRoom = null;
            document.getElementById('current-room').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É';
            document.getElementById('messages').innerHTML = `
                <div class="welcome-message">
                    <h3>üêç –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ChatTM!</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            `;
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('room-users').innerHTML = '';
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        
        if (text && currentRoom) {
            socket.emit('chat_message', {
                room: currentRoom,
                text: text
            });
            input.value = '';
            
            socket.emit('typing', {room: currentRoom, is_typing: false});
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        } else if (currentRoom) {
            socket.emit('typing', {room: currentRoom, is_typing: true});
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                socket.emit('typing', {room: currentRoom, is_typing: false});
            }, 1000);
        }
    }

    //  SOCKET EVENT HANDLERS 

    // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    socket.on('new_message', function(data) {
        if (data.room === currentRoom) {
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = `
                <div class="message-header">
                    <span class="message-username">${data.username}</span>
                    <span class="message-time">${data.timestamp}</span>
                </div>
                <div class="message-text">${data.text}</div>
            `;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
        }
    });

    // –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    socket.on('system_message', function(data) {
        if (!data.room || data.room === currentRoom) {
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `system-message ${data.type}`;
            messageEl.innerHTML = `‚ö° ${data.text}`;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
        }
    });

    // –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–Ω–∞—Ç—ã
    socket.on('room_history', function(data) {
        if (data.room === currentRoom) {
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            data.messages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                messageEl.innerHTML = `
                    <div class="message-header">
                        <span class="message-username">${msg.username}</span>
                        <span class="message-time">${msg.timestamp}</span>
                    </div>
                    <div class="message-text">${msg.text}</div>
                `;
                messages.appendChild(messageEl);
            });
            
            messages.scrollTop = messages.scrollHeight;
        }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    socket.on('user_list_update', function(data) {
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '';
        
        data.users.forEach(user => {
            const userEl = document.createElement('div');
            userEl.className = 'user-item';
            userEl.innerHTML = `${user}`;
            usersList.appendChild(userEl);
        });
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ–º–Ω–∞—Ç—ã
    socket.on('room_users_update', function(data) {
        if (data.room === currentRoom) {
            const roomUsers = document.getElementById('room-users');
            roomUsers.innerHTML = `–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${data.users.join(', ')}`;
        }
    });

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    socket.on('user_typing', function(data) {
        if (data.room === currentRoom) {
            const indicator = document.getElementById('typing-indicator');
            if (data.is_typing) {
                indicator.textContent = ` ${data.username} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
            } else {
                indicator.textContent = '';
            }
        }
    });

    // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ general –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        setTimeout(() => joinRoom('general'), 1000);
    };
</script>
{% endblock %}
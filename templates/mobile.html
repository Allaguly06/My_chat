{% extends "base.html" %}

{% block title %}–ú–æ–±–∏–ª—å–Ω—ã–π —á–∞—Ç - ChatTM{% endblock %}

{% block extra_css %}
<style>
    .mobile-container {
        padding: 10px;
        height: calc(100vh - 120px);
    }
    
    .mobile-rooms {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .mobile-room {
        background: var(--card-bg);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
    }
    
    .mobile-chat {
        display: none;
        flex-direction: column;
        height: 100%;
    }
    
    .mobile-header {
        background: var(--primary-color);
        color: white;
        padding: 15px;
        border-radius: 10px 10px 0 0;
    }
    
    .mobile-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background: var(--bg-color);
    }
    
    .mobile-input {
        display: flex;
        padding: 10px;
        background: var(--card-bg);
        border-radius: 0 0 10px 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="mobile-container">
    <div id="mobile-rooms" class="mobile-rooms">
        {% for room_name, room_data in rooms.items() %}
        <div class="mobile-room" onclick="joinMobileRoom('{{ room_name }}')">
            <h4># {{ room_name }}</h4>
            <p>{{ room_data.description }}</p>
            <small>{{ room_data.users|length }}  ‚Ä¢ {{ room_data.messages|length }} </small>
        </div>
        {% endfor %}
    </div>

    <div id="mobile-chat" class="mobile-chat">
        <div class="mobile-header">
            <h3 id="mobile-room-name"># general</h3>
            <button onclick="leaveMobileRoom()" style="float: right;">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <div id="mobile-messages" class="mobile-messages"></div>
        
        <div class="mobile-input">
            <input type="text" id="mobile-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1;">
            <button onclick="sendMobileMessage()">üì§</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    let currentMobileRoom = null;

    function joinMobileRoom(roomName) {
        currentMobileRoom = roomName;
        document.getElementById('mobile-rooms').style.display = 'none';
        document.getElementById('mobile-chat').style.display = 'flex';
        document.getElementById('mobile-room-name').textContent = `# ${roomName}`;
        
        socket.emit('join_room', {room: roomName});
    }

    function leaveMobileRoom() {
        if (currentMobileRoom) {
            socket.emit('leave_room', {room: currentMobileRoom});
        }
        
        document.getElementById('mobile-rooms').style.display = 'grid';
        document.getElementById('mobile-chat').style.display = 'none';
        currentMobileRoom = null;
    }

    function sendMobileMessage() {
        const input = document.getElementById('mobile-input');
        const text = input.value.trim();
        
        if (text && currentMobileRoom) {
            socket.emit('chat_message', {
                room: currentMobileRoom,
                text: text
            });
            input.value = '';
        }
    }

    // Socket event handlers
    socket.on('new_message', function(data) {
        if (data.room === currentMobileRoom) {
            const messages = document.getElementById('mobile-messages');
            const messageEl = document.createElement('div');
            messageEl.innerHTML = `<strong>${data.username}:</strong> ${data.text}`;
            messages.appendChild(messageEl);
            messages.scrollTop = messages.scrollHeight;
        }
    });

    socket.on('room_history', function(data) {
        if (data.room === currentMobileRoom) {
            const messages = document.getElementById('mobile-messages');
            messages.innerHTML = '';
            
            data.messages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.innerHTML = `<strong>${msg.username}:</strong> ${msg.text}`;
                messages.appendChild(messageEl);
            });
            
            messages.scrollTop = messages.scrollHeight;
        }
    });

    // Enter key support
    document.getElementById('mobile-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMobileMessage();
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}–ß–∞—Ç - Modern Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    .users-sidebar {
        border-right: 1px solid #dee2e6;
        background: #f8f9fa;
    }
    .chat-area {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: grey;
    }
    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        background: #f8f9fa;
        max-width: 80%;
    }
    .message.own {
        background: #007bff;
        color: white;
        margin-left: auto;
    }
    .message.other {
        background: #e9ecef;
        margin-right: auto;
    }
    .message.system {
        background: transparent;
        max-width: 100%;
        text-align: center;
    }
    .message-header {
        font-size: 0.875rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
        display: flex;
        justify-content: space-between;
    }
    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
    }
    .online-badge {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #28a745;
        display: inline-block;
        margin-right: 8px;
    }
    .offline-badge {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6c757d;
        display: inline-block;
        margin-right: 8px;
    }
    .typing-indicator {
        font-style: italic;
        color: #6c757d;
        padding: 0.5rem;
        display: none;
    }
    .user-status {
        font-size: 0.75rem;
    }
    .user-item {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .user-item:hover {
        background-color: #e9ecef !important;
        transform: translateX(3px);
    }
    .user-online {
        border-left: 3px solid #28a745 !important;
    }
    .user-offline {
        border-left: 3px solid #6c757d !important;
    }
    .chat-online {
        border-left: 3px solid #17a2b8 !important;
    }
    .chat-group {
        border-left: 3px solid #ffc107 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Users Section -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-people-fill"></i> –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    <span class="badge bg-success float-end" id="online-count">{{ online_users|length }} –æ–Ω–ª–∞–π–Ω</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="users-list">
                    {% for user in all_users %}
                    {% if user != username %}
                    <div class="list-group-item user-item start-private-chat 
                                {% if user in online_users %}user-online{% else %}user-offline{% endif %}" 
                         data-user="{{ user }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                {% if user in online_users %}
                                <span class="online-badge"></span>
                                {% else %}
                                <span class="offline-badge"></span>
                                {% endif %}
                                <strong>{{ user }}</strong>
                            </div>
                            <div>
                                {% if user in online_users %}
                                <small class="text-success user-status">online</small>
                                {% else %}
                                <small class="text-muted user-status">offline</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">
                                {% if user in online_users %}
                                üü¢ –í —Å–µ—Ç–∏
                                {% else %}
                                ‚ö´ –ù–µ –≤ —Å–µ—Ç–∏
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    
                    {% if all_users|length <= 1 %}
                    <div class="list-group-item text-center text-muted">
                        <i class="bi bi-person-x"></i><br>
                        –î—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Private Chats Section -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="bi bi-chat-dots"></i> –ú–æ–∏ –¥–∏–∞–ª–æ–≥–∏
                    <span class="badge bg-light text-dark float-end">{{ private_chats|length }}</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="private-chats-list">
                    {% for chat in private_chats %}
                    <div class="list-group-item user-item open-private-chat chat-online" 
                         data-chat-id="{{ chat.chat_id }}"
                         data-user="{{ chat.other_user }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>{{ chat.other_user }}</strong>
                            <small class="text-muted">{{ chat.last_message_timestamp|default('') }}</small>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">
                                {{ chat.last_message|default('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π')|truncate(30) }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not private_chats %}
                    <div class="list-group-item text-center text-muted">
                        <i class="bi bi-chat"></i><br>
                        –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Groups Section -->
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi bi-people"></i> –ú–æ–∏ –≥—Ä—É–ø–ø—ã
                </h6>
                <a href="{{ url_for('create_group') }}" class="btn btn-sm btn-outline-dark">
                    <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å
                </a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="groups-list">
                    {% for group in groups %}
                    <div class="list-group-item user-item join-group chat-group" 
                         data-group-id="{{ group.group_id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ group.name }}</strong>
                                {% if group.admin == username %}
                                <span class="badge bg-primary ms-1">–í—ã –∞–¥–º–∏–Ω</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ group.member_count }} —É—á–∞—Å—Ç.</small>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">
                                –ê–¥–º–∏–Ω: {{ group.admin }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not groups %}
                    <div class="list-group-item text-center text-muted">
                        <i class="bi bi-people"></i><br>
                        –í—ã –Ω–µ –≤ –≥—Ä—É–ø–ø–∞—Ö
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-8">
        <div class="card chat-container">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0" id="current-chat-title">
                    <i class="bi bi-chat-left-text"></i> –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è
                </h5>
            </div>
            
            <div class="chat-area">
                <!-- Messages Container -->
                <div class="messages-container" id="messages-container">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-chat-square-heart display-1 text-primary"></i>
                        <h4 class="mt-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, {{ username }}! üëã</h4>
                        <p class="mt-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                        <div class="mt-4">
                            <small class="text-muted">
                                üü¢ –ó–µ–ª–µ–Ω—ã–π - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω<br>
                                ‚ö´ –°–µ—Ä—ã–π - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ñ—Ñ–ª–∞–π–Ω<br>
                                üí¨ –°–∏–Ω–∏–π - –≤–∞—à–∏ –¥–∏–∞–ª–æ–≥–∏<br>
                                üë• –ñ–µ–ª—Ç—ã–π - –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator">
                    <span id="typing-user"></span> –ø–µ—á–∞—Ç–∞–µ—Ç<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
                
                <!-- Message Input -->
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" 
                               placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è..." disabled>
                        <button class="btn btn-primary" id="send-button" disabled>
                            <i class="bi bi-send-fill"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden fields -->
<input type="hidden" id="current-username" value="{{ username }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ UI
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Chat interface initialized');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(5px)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
        if (!currentChatId) {
            addSystemMessage('üí° –°–æ–≤–µ—Ç: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç!');
        }
    }, 2000);
});

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function addSystemMessage(text) {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer && !currentChatId) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system text-center';
        messageDiv.innerHTML = `<div class="text-muted"><em>${text}</em></div>`;
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
function scrollToBottom() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    }
}
</script>
{% endblock %}